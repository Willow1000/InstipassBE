{% extends "base.html" %}
{% block title %}Deficits Management{% endblock %}
{% block content %}
    {% include "admin_nav.html" %}

    <div class="container-fluid py-4">
        <!-- Messages -->
        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="bi bi-info-circle me-2"></i>{{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 text-white mb-1">Outstanding Deficits</h1>
                        <p class="text-muted mb-0">Manage and monitor institution payment deficits</p>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary fs-6">Total Deficits: {{ deficits|length }}</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshPage()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Deficit Record Button -->
        <div class="row mb-4">
            <div class="col-12">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDeficitModal">
                    <i class="bi bi-plus-circle me-2"></i>Create Deficit Record
                </button>
            </div>
        </div>

        {% if deficits %}
            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Search</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchDeficits" placeholder="Search by institution...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small">Balance Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="DOWNPAYMENT">Down Payment</option>
                                <option value="FINAL_PAYMENT">Final Payment</option>
                                <option value="ADJUSTMENT">Adjustment / Correction</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-muted small">Date Range</label>
                            <select class="form-select" id="dateFilter">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center border-0 bg-primary bg-opacity-10">
                        <div class="card-body">
                            <i class="bi bi-exclamation-triangle text-primary bi-2x mb-2"></i>
                            <h5 class="card-title text-primary">{{ deficits|length }}</h5>
                            <p class="card-text text-muted small">Total Deficits</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center border-0 bg-info bg-opacity-10">
                        <div class="card-body">
                            <i class="bi bi-building text-info bi-2x mb-2"></i>
                            <h5 class="card-title text-info" id="institutionCount">{{ institutions_count|default:0 }}</h5>
                            <p class="card-text text-muted small">Institutions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center border-0 bg-success bg-opacity-10">
                        <div class="card-body">
                            <i class="bi bi-currency-exchange text-success bi-2x mb-2"></i>
                            <h5 class="card-title text-success" id="totalAmount">{{ total_amount|default:0 }}</h5>
                            <p class="card-text text-muted small">Total Deficit Amount</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deficits Table -->
            <div class="card">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-dark">Deficit Records</h5>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small" id="filteredCount">{{ deficits|length }} records</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="deficitsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="px-3 py-3" style="width: 200px;"><small>Institution</small></th>
                                    <th class="px-3 py-3" style="width: 120px;"><small>Amount</small></th>
                                    <th class="px-3 py-3" style="width: 150px;"><small>Balance Type</small></th>
                                    <th class="px-3 py-3" style="width: 160px;"><small>Created At</small></th>
                                    <th class="px-3 py-3" style="width: 160px;"><small>Last Updated</small></th>
                                    <th class="px-3 py-3 text-center" style="width: 160px;"><small>Actions</small></th>
                                </tr>
                            </thead>
                            <tbody id="deficitsTableBody">
                                {% for deficit in deficits %}
                                    {% if deficit.amount %}
                                <tr class="deficit-row"
                                    data-institution="{{ deficit.institution.name }}"
                                    data-type="{{ deficit.type }}"
                                    data-amount="{{ deficit.amount }}"
                                    data-date="{{ deficit.created_at|date:'Y-m-d' }}"
                                    data-created="{{ deficit.created_at|date:'Y-m-d H:i:s' }}">

                                    <td class="px-3 py-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-building text-primary me-2"></i>
                                            <span class="fw-medium">{{ deficit.institution }}</span>
                                        </div>
                                    </td>

                                    <td class="px-3 py-2">
                                        <div class="d-flex align-items-center">
                                            <span class="fw-medium text-danger">KES {{ deficit.amount }}</span>
                                        </div>
                                    </td>

                                    <td class="px-3 py-2">
                                        <span class="badge bg-secondary">
                                            {% if deficit.type == "DOWNPAYMENT" %}
                                                Down Payment
                                            {% elif deficit.type == "FINAL_PAYMENT" %}
                                                Final Payment
                                            {% elif deficit.type == "ADJUSTMENT" %}
                                                Adjustment / Correction
                                            {% else %}
                                                Not Specified
                                            {% endif %}
                                        </span>
                                    </td>

                                    <td class="px-3 py-2">
                                        <small class="text-muted">
                                            {{ deficit.created_at|date:"M d, Y" }}<br>
                                            {{ deficit.created_at|date:"H:i:s" }}
                                        </small>
                                    </td>

                                    <td class="px-3 py-2">
                                        <small class="text-muted">
                                            {{ deficit.updated_at|date:"M d, Y" }}<br>
                                            {{ deficit.updated_at|date:"H:i:s" }}
                                        </small>
                                    </td>

                                    <td class="px-3 py-3 text-center">
                                        <div class="btn-group d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-info deficit-details-btn" 
                                                    data-deficit-id="{{ deficit.id }}"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deficitDetailsModal">
                                                <i class="bi bi-eye me-1"></i>Details
                                            </button>
                                            <button class="btn btn-sm btn-success send-invoice-btn"
                                                    data-deficit-id="{{ deficit.id }}"
                                                    data-institution-id="{{ deficit.institution.id }}"
                                                    data-institution="{{ deficit.institution.name }}"
                                                    data-amount="{{ deficit.amount }}"
                                                    data-type="{{ deficit.type }}">
                                                <i class="bi bi-send me-1"></i>Send Invoice
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">No Deficits Found</h4>
                <p class="text-muted">All institutions are up to date with their payments.</p>
            </div>
        {% endif %}
    </div>

    <!-- Create Deficit Record Modal -->
    <div class="modal fade" id="createDeficitModal" tabindex="-1" aria-labelledby="createDeficitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createDeficitModalLabel">Create Deficit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createDeficitForm" action="http://127.0.0.1:8000/super/create/deficit/" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="institution" class="form-label">Institution *</label>
                                <select class="form-select" id="institution" name="institution" required>
                                    <option value="">Select Institution</option>
                                    {% for institution in institutions %}
                                        <option value="{{ institution.id }}">{{ institution.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select the institution with the deficit</div>
                            </div>
                            <div class="col-md-6">
                                <label for="amount" class="form-label">Deficit Amount (KES) *</label>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01" required placeholder="0.00">
                                <div class="form-text">Enter the outstanding deficit amount</div>
                            </div>
                            <div class="col-md-6">
                                <label for="type" class="form-label">Balance Type *</label>
                                <select class="form-select" id="type" name="type" required>
                                    <option value="">Select Balance Type</option>
                                    <option value="DOWNPAYMENT">Down Payment</option>
                                    <option value="FINAL_PAYMENT">Final Payment</option>
                                    <option value="ADJUSTMENT">Adjustment / Correction</option>
                                </select>
                                <div class="form-text">Select the type of balance this deficit represents</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Currency</label>
                                <div class="form-control ">KES (Kenyan Shillings)</div>
                                <div class="form-text">All deficits are recorded in Kenyan Shillings</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="createDeficitBtn">Create Deficit Record</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deficit Details Modal -->
    <div class="modal fade" id="deficitDetailsModal" tabindex="-1" aria-labelledby="deficitDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deficitDetailsModalLabel">Deficit Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="deficitDetailsContent">
                    <!-- Deficit details will be loaded here via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Search, Filter, and Stats -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchDeficits');
            const typeFilter = document.getElementById('typeFilter');
            const dateFilter = document.getElementById('dateFilter');
            const tableBody = document.getElementById('deficitsTableBody');
            const allRows = Array.from(tableBody.querySelectorAll('.deficit-row'));
            const filteredCount = document.getElementById('filteredCount');
            const createDeficitForm = document.getElementById('createDeficitForm');
            const createDeficitBtn = document.getElementById('createDeficitBtn');

            let currentPage = 1;
            let filteredRows = [...allRows];

            // Update statistics and count
            function updateStatistics(rows) {
                const institutionCount = new Set(rows.map(row => row.dataset.institution)).size;
                const totalAmount = rows.reduce((sum, row) => {
                    return sum + parseFloat(row.dataset.amount || 0);
                }, 0);

                document.getElementById('institutionCount').textContent = institutionCount;
                document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
                filteredCount.textContent = `${rows.length} record${rows.length !== 1 ? 's' : ''}`;
            }

            // Date range check
            function isDateInRange(dateStr, range) {
                if (!dateStr || !range) return true;
                const today = new Date();
                const rowDate = new Date(dateStr);

                const todayStr = today.toISOString().split('T')[0];
                const day = today.getDay();
                const month = today.getMonth();
                const year = today.getFullYear();

                switch (range) {
                    case 'today':
                        return dateStr === todayStr;
                    case 'week':
                        const firstDayOfWeek = new Date(today);
                        firstDayOfWeek.setDate(today.getDate() - day);
                        firstDayOfWeek.setHours(0, 0, 0, 0);
                        const lastDayOfWeek = new Date(firstDayOfWeek);
                        lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
                        return rowDate >= firstDayOfWeek && rowDate <= lastDayOfWeek;
                    case 'month':
                        return rowDate.getMonth() === month && rowDate.getFullYear() === year;
                    default:
                        return true;
                }
            }

            // Filter logic
            function filterDeficits() {
                const term = searchInput.value.toLowerCase();
                const type = typeFilter.value;
                const date = dateFilter.value;

                filteredRows = allRows.filter(row => {
                    const inst = (row.dataset.institution || '').toLowerCase();
                    const rowType = row.dataset.type || '';

                    const matchesSearch = !term || inst.includes(term);
                    const matchesType = !type || rowType === type;
                    const matchesDate = isDateInRange(row.dataset.date, date);

                    return matchesSearch && matchesType && matchesDate;
                });

                updateStatistics(filteredRows);
                currentPage = 1;
                displayRows();
            }

            // Display rows with pagination
            function displayRows() {
                const perPage = 50;
                const start = (currentPage - 1) * perPage;
                const end = start + perPage;

                allRows.forEach(r => r.style.display = 'none');
                filteredRows.slice(start, end).forEach(r => r.style.display = '');
            }

            // Create Deficit Form Submission Handler
            createDeficitForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Disable submit button to prevent multiple submissions
                createDeficitBtn.disabled = true;
                createDeficitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...';
                
                const formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if deficit creation was successful
                    if (data.success || data.id) {
                        // Show success message
                        showAlert('Deficit record created successfully!', 'success');
                        
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createDeficitModal'));
                        modal.hide();
                        
                        // Refresh the page after a short delay to show the success message
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        throw new Error(data.error || 'Deficit creation failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error creating deficit record: ' + error.message, 'danger');
                    
                    // Re-enable submit button
                    createDeficitBtn.disabled = false;
                    createDeficitBtn.innerHTML = 'Create Deficit Record';
                });
            });

            // Reset form when modal is closed
            document.getElementById('createDeficitModal').addEventListener('hidden.bs.modal', function () {
                createDeficitForm.reset();
                createDeficitBtn.disabled = false;
                createDeficitBtn.innerHTML = 'Create Deficit Record';
            });

            // Send Invoice AJAX handler
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('send-invoice-btn') || 
                    e.target.closest('.send-invoice-btn')) {
                    
                    const button = e.target.classList.contains('send-invoice-btn') ? 
                                  e.target : e.target.closest('.send-invoice-btn');
                    
                    const institutionId = button.getAttribute('data-institution-id');
                    const institutionName = button.getAttribute('data-institution');
                    const amount = button.getAttribute('data-amount');
                    const deficitId = button.getAttribute('data-deficit-id');
                    
                    // Show loading state
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
                    button.disabled = true;
                    
                    // Send AJAX request
                    fetch(`/super/send/invoice/${institutionId}`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                    })
                    .then(response => {
                        // First check if response is ok
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Invoice response:', data);
                        
                        // Handle different response formats
                        if (data.success === true || data.status === 'success' || data.message) {
                            showAlert(`Invoice sent successfully to ${institutionName}`, 'success');
                            // Refresh the page after a short delay
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            // Check if we have an error message
                            if (data.error) {
                                throw new Error(data.error);
                            } else {
                                // If no specific success flag but no error either, assume success
                                showAlert(`Invoice sent successfully to ${institutionName}`, 'success');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 2000);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error sending invoice:', error);
                        showAlert(`Failed to send invoice: ${error.message}`, 'danger');
                        
                        // Reset button
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
                }
            });

            // CSRF token helper function
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Helper function to get display name for balance type
            function getTypeDisplayName(type) {
                switch(type) {
                    case 'DOWNPAYMENT': return 'Down Payment';
                    case 'FINAL_PAYMENT': return 'Final Payment';
                    case 'ADJUSTMENT': return 'Adjustment / Correction';
                    default: return 'Not Specified';
                }
            }

            // Deficit details modal handler
            document.querySelectorAll('.deficit-details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const deficitId = this.getAttribute('data-deficit-id');
                    const row = this.closest('tr');
                    const institution = row.dataset.institution;
                    const amount = row.dataset.amount;
                    const type = getTypeDisplayName(row.dataset.type);
                    const createdAt = row.dataset.created;
                    
                    const createdDate = new Date(createdAt);
                    const formattedDate = createdDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const detailsContent = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Basic Information</h6>
                                <p><strong>Institution:</strong> ${institution}</p>
                                <p><strong>Deficit Amount:</strong> KES ${amount}</p>
                                <p><strong>Balance Type:</strong> ${type}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Timeline</h6>
                                <p><strong>Created At:</strong> ${formattedDate}</p>
                                <p><strong>Deficit ID:</strong> ${deficitId}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    You can send an invoice to this institution using the "Send Invoice" button in the table.
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('deficitDetailsContent').innerHTML = detailsContent;
                });
            });

            // Show alert function
            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const container = document.querySelector('.container-fluid');
                const existingAlerts = container.querySelector('.alert');
                if (existingAlerts) {
                    container.insertBefore(alertDiv, existingAlerts);
                } else {
                    container.insertBefore(alertDiv, container.firstChild);
                }
                
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            // Event Listeners
            searchInput.addEventListener('input', filterDeficits);
            typeFilter.addEventListener('change', filterDeficits);
            dateFilter.addEventListener('change', filterDeficits);

            // Initial load
            updateStatistics(allRows);
            displayRows();
        });

        // Helper Functions
        function clearFilters() {
            document.getElementById('searchDeficits').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('searchDeficits').dispatchEvent(new Event('input'));
        }

        function refreshPage() {
            location.reload();
        }

        // Global showAlert function
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            const existingAlerts = container.querySelector('.alert');
            if (existingAlerts) {
                container.insertBefore(alertDiv, existingAlerts);
            } else {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
{% endblock %}